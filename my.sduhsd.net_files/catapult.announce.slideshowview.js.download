var CatapultAnnounce = CatapultAnnounce || {};

(function ($)
{
	$.extend(true, CatapultAnnounce,
	{
		SlideShowViewLoader: function (element)
		{
			this.element = (element instanceof $) ? element : $(element);
		}
	});

	CatapultAnnounce.SlideShowViewLoader.MainUrl = $('script[src*=catapult\\.announce\\.slideshowview]').attr('src').replace(/catapult.announce.slideshowview\.js.*$/, '');

	CatapultAnnounce.SlideShowViewLoader.loadPage = function ()
	{
		CatapultAnnounce.PageLoader.loadPage(CatapultAnnounce.SlideShowViewLoader.MainUrl + "../pages/catapult.announce.slideshowview.html?date=2020-02-18-09-00", function ()
		{
			initializeUI();
		});

		return true;
	};

	function initializeUI()
	{
		initializeControls();

		clearSelectedPostAndFillPosts();
	}

	function initializeControls()
	{
	}

	function clearSelectedPostAndFillPosts()
	{
		CatapultAnnounce.global.WorkingPostId('');
		fillPosts();
		if (!CatapultAnnounce.global.BlockAlerts) { fillAlerts(); }
	}

	function likeButton_click(e)
	{
		e.preventDefault();

		var likeButton = $(this);

		CatapultAnnounce.Likes.likeAPost($(likeButton).data('id'), function (numberOfLikes)
		{
			if (numberOfLikes > 0)
			{
				$(likeButton).children('.numberoflikes').html('(' + numberOfLikes + ')');
				var likeIcon = $(likeButton).children('.fa-thumbs-o-up')
				$(likeIcon).removeClass('fa-thumbs-o-up');
				$(likeIcon).addClass('fa-thumbs-up');
			}
		});
	}

	function shareButton_click(e)
	{
		e.preventDefault();

		showShareDialog($(this).data('id'), $(this).data('shareurl'));
	}

	function fillPosts()
	{
		var numberOfItems = CatapultAnnounce.global.DisplayNumberOfItems;
		if(numberOfItems == "") { numberOfItems = "!!all!!"; }

		var configuration = {};
		configuration.SearchTitleString = "!!blank!!";
		configuration.SearchDescriptionString = "!!blank!!";
		configuration.OrganizationId = "!!all!!";
		configuration.SiteId = "!!all!!";
		configuration.FeedIdList = CatapultAnnounce.global.FeedList.join(',')
		configuration.Category = "!!all!!";
		configuration.Priority = "!!all!!";
		configuration.StartDateString = "!!all!!";
		configuration.EndDateString = "!!current!!";
		configuration.NumberOfItems = numberOfItems;
		configuration.ShowEnded = "false";
		configuration.ShowFuture = "false";
		configuration.ShowDraft = "false";
		configuration.OrderBy = "date";
		configuration.IsBackend = "false";

		var url = CatapultAnnounce.global.ProgramUrl + "Connector/Post/v2/Search";
		CatapultAnnounce.ServiceConnector.connect('PUT', JSON.stringify(configuration), url, function (response)
		{
			var listContainer = $('#catapultannounce-postList').empty();
			var fancyboxContainer = $('#catapultannounce-fancyboxContainer').empty();

			var mainContainer = $('<section/>', { class: 'catapultannounce-slideshow slider' }).appendTo(listContainer);
			if (response && response.length > 0)
			{
				var screenWidth = getScreenWidth();
				for (count = 0; count < response.length; count++)
				{
					var item = response[count];

					// NOTE: 03/23/2018 - Per Jediah, if there is not image, skip the item
					if ((item.PictureInfo && item.PictureInfo.Picture250Url != "") || (item.DefaultPictureInfo && item.DefaultPictureInfo.Picture250Url != ""))
					{
						var container = $('<div/>', { class: 'catapultannounce-slideshow-item', 'data-id': item.Id }).appendTo(mainContainer);

//						if(item.Priority > 0)
//						{
//							$(listItem).addClass('catapultannounce-item-priority');
//						}

						var linkItem = $('<a/>', { class: 'catapultannounce-link' + (item.RedirectLinkUrl != '' ? '' : ' fancybox'), 'rel': 'catapultannounce-slideshow', href: (item.RedirectLinkUrl != '' ? item.RedirectLinkUrl : '#inline' + item.Id), 'data-id': item.Id, 'target': '_blank' }).appendTo(container);
						linkItem.on('click', function (e)
						{
							CatapultAnnounce.Clicks.clickAPost($(this).data('id'), function (response) { });
						});

						if (item.YouTubeEmbed && item.YouTubeEmbed != "")
						{
							$('<div/>', { class: 'catapultannounce-slide', style: "background: url('" + item.YouTubeEmbedPreviewPicture + "') center no-repeat; background-size:cover;" }).appendTo(linkItem);
							$('<input/>', { type: 'hidden', id: 'catapultannounce-slideshow-pictureAltTag' + item.Id, value: (item.PictureAltTag != '' ? item.PictureAltTag : 'Youtube Video') }).appendTo(linkItem);
						}
						else if (item.PictureInfo && item.PictureInfo.Picture250Url != "")
						{
							$('<div/>', { class: 'catapultannounce-slide', style: "background: url('" + item.PictureInfo.Picture800Url + "') center no-repeat; background-size:cover;" }).appendTo(linkItem);
							$('<input/>', { type: 'hidden', id: 'catapultannounce-slideshow-pictureAltTag' + item.Id, value: item.PictureAltTag }).appendTo(linkItem);
						}
						else if (item.DefaultPictureInfo && item.DefaultPictureInfo.Picture250Url != "")
						{
							$('<div/>', { class: 'catapultannounce-slide', style: "background: url('" + item.DefaultPictureInfo.Picture800Url + "') center no-repeat; background-size:cover;" }).appendTo(linkItem);
							$('<input/>', { type: 'hidden', id: 'catapultannounce-slideshow-pictureAltTag' + item.Id, value: item.DefaultPictureAltTag }).appendTo(linkItem);
						}

						var postText = $('<div/>', { class: 'catapultannounce-text' }).appendTo($('<figcaption/>', { }).appendTo(linkItem));

						var titleRow = $('<div/>', { class: 'catapultannounce-title-row' }).appendTo(postText);
						$('<h3/>', { html: item.Title, class: 'catapultannounce-title' }).appendTo(titleRow);
						$('<date/>', { html: item.HRListPostDate, class: 'catapultannounce-date' }).appendTo(titleRow);

						$('<article/>', { class: 'catapultannounce-detail', html: item.HRDescription + '<span class="readmore">' + item.DefaultReadMoreButtonLabel + '</span>' }).appendTo(postText);

						// fancybox item
						var fancyboxItem = $('<div/>', { 'id': 'inline' + item.Id, class: 'catapultannounce-popup', 'data-id': item.Id, style: 'display:none;' }).appendTo(fancyboxContainer);

						var fancyboxTitleRow = $('<div/>', { class: 'catapultannounce-title-row' }).appendTo(fancyboxItem);
						$('<h2/>', { class: 'catapultannounce-title', html: item.Title }).appendTo(fancyboxTitleRow);
						$('<date/>', { class: 'catapultannounce-date', html: item.HRDetailPostDate }).appendTo(fancyboxTitleRow);

						var fancyboxArticle = $('<article/>', { }).appendTo(fancyboxItem);

						if(screenWidth > 700)
						{
							if (item.YouTubeEmbed && item.YouTubeEmbed != "") { $('<div/>', { html: item.YouTubeEmbed, class: 'catapultannounce-youtubeembed' }).appendTo($('<div/>', { style: 'width:100%;' }).appendTo(fancyboxArticle)); }
							else if (item.PictureInfo && item.PictureInfo.Picture800Url != "") { $('<img/>', { src: item.PictureInfo.Picture800Url, 'alt': item.PictureAltTag, 'title': item.PictureAltTag }).appendTo(fancyboxArticle); }
							else if (item.DefaultPictureInfo && item.DefaultPictureInfo.Picture800Url != "") { $('<img/>', { src: item.DefaultPictureInfo.Picture800Url, 'alt': item.DefaultPictureAltTag, 'title': item.DefaultPictureAltTag }).appendTo(fancyboxArticle); }
						}
						else
						{
							if (item.YouTubeEmbed && item.YouTubeEmbed != "") { $('<div/>', { html: item.YouTubeEmbed, class: 'catapultannounce-youtubeembed' }).appendTo($('<div/>', { style: 'width:100%;' }).appendTo(fancyboxArticle)); }
							else if (item.PictureInfo && item.PictureInfo.Picture500Url != "") { $('<img/>', { src: item.PictureInfo.Picture500Url, 'alt': item.PictureAltTag, 'title': item.PictureAltTag }).appendTo(fancyboxArticle); }
							else if (item.DefaultPictureInfo && item.DefaultPictureInfo.Picture500Url != "") { $('<img/>', { src: item.DefaultPictureInfo.Picture500Url, 'alt': item.DefaultPictureAltTag, 'title': item.DefaultPictureAltTag }).appendTo(fancyboxArticle); }
						}

						var descriptionHtml = "<div>" + item.Description + "</div>";

						if(item.Documents && item.Documents.length > 0)
						{
							descriptionHtml += "<div><br /></div><div><div><strong>Documents:</strong></div><ul>";

							$.each(item.Documents, function(index, documentItem)
							{
								descriptionHtml += "<li><a href='" + documentItem.HRUrl + "' title='" + documentItem.Title + "' alt='" + documentItem.Title + "' target='_blank'>" + documentItem.Title + "</a></li>";
							});

							descriptionHtml += "</ul></div>";
						}

						descriptionHtml += "<div><br /></div>";

						$('<p/>', { html: descriptionHtml }).appendTo(fancyboxArticle);

						var fancyboxFooter = $('<footer/>', {}).appendTo(fancyboxItem);

						var likeButton = $('<a/>', { class: 'catapultannounce-right post-like-button', href: '#', html: '<i class="fa ' + (CatapultAnnounce.Likes.haveLikedAPost(item.Id) ? 'fa-thumbs-up' : 'fa-thumbs-o-up') + '" alt="Like" title="Like"></i> Like <span class="numberoflikes">' + (item.HRNumberOfLikes > 0 ? '(' + item.HRNumberOfLikes + ')' : '') + '</span>', 'data-id': item.Id }).appendTo(fancyboxFooter);
						$(likeButton).on('click', likeButton_click);

						if (CatapultAnnounce.global.ShareUrl != "")
						{
							var shareButton = $('<a/>', { class: 'catapultannounce-right', href: '#', html: '<i class="fa fa-share" alt="Share" title="Share"></i> ' + item.DefaultShareButtonLabel + '', 'data-id': item.Id, 'data-shareurl': CatapultAnnounce.global.ShareUrl }).appendTo(fancyboxFooter);
							$(shareButton).on('click', shareButton_click);
						}
						else if(item.FeedShareUrl != "")
						{
							var shareButton = $('<a/>', { class: 'catapultannounce-right', href: '#', html: '<i class="fa fa-share" alt="Share" title="Share"></i> ' + item.DefaultShareButtonLabel + '', 'data-id': item.Id, 'data-shareurl': item.FeedShareUrl }).appendTo(fancyboxFooter);
							$(shareButton).on('click', shareButton_click);
						}
					}
				}

				var fancyboxAllItemsButtonContainer = $('<li/>', { class: 'all-catapultannounce-item' });

				if (CatapultAnnounce.global.BlogViewUrlPosition == 'above') { fancyboxAllItemsButtonContainer.prependTo(listContainer); }
				else { fancyboxAllItemsButtonContainer.appendTo(listContainer); }

				var fancyboxAllItemsButton = $('<a/>', { class: 'all-catapultannounce-link', href: '', html: CatapultAnnounce.global.BlogViewUrlText }).appendTo(fancyboxAllItemsButtonContainer);
				fancyboxAllItemsButton.on('click', fancyboxAllItemsButton_onclick);
			}
			else
			{
				var container = $('<div/>', { class: 'catapultannounce-slideshow-item', 'data-id': item.Id }).appendTo(mainContainer);
				var linkItem = $('<a/>', { class: 'catapultannounce-link fancybox', 'rel': 'catapultannounce-slideshow', href: '#', 'data-id': '-1' }).appendTo(container);
				linkItem.on('click', catapultannounceItemLink_onclick);
				var postText = $('<div/>', { class: 'catapultannounce-text' }).appendTo(linkItem);
				var titleRow = $('<div/>', { class: 'catapultannounce-title-row' }).appendTo(postText);
				$('<h3/>', { html: 'No Items', class: 'catapultannounce-title' }).appendTo(titleRow);
			}

			$('.catapultannounce-slideshow').on('init', function (event, slick)
			{
				window.setTimeout(function()
				{
					$.each(slick.$slides, function(index, item)
					{
						var dataId = $(item).data('id');
						var altText = $('#catapultannounce-slideshow-pictureAltTag' + dataId).val();
						var dotId = $(item).attr('aria-describedby');

						// take into account old versions of slick
						if($('.catapultannounce-slideshow #' + dotId).is('button'))
						{
							$('.catapultannounce-slideshow #' + dotId).html(altText);
						}
						else
						{
							$('.catapultannounce-slideshow #' + dotId).find('button').html(altText);
						}
					});
				}, 100);
			});

			$(".catapultannounce-slideshow").slick({
				dots: true,
				fade: true,
				centerMode: true,
				autoplay: true
			});

			// truncate the items
			try
			{
				$(document).ready(function ()
				{
					setupDotDotDotTrunctate('.catapultannounce-detail', { watch: "window", after: "span.readmore" });
					setupDotDotDotTrunctate('.catapultannounce-title', { watch: "window" });

					var fancyboxConfiguration = CatapultAnnounce.global.fancyboxConfiguration;
					fancyboxConfiguration.afterLoad = function (upcoming, current)
					{
						// if both upcoming and current are filled out, then most likely this is someone pressing the prev/next buttons.  Log a click.
						if (upcoming && current)
						{
							CatapultAnnounce.Clicks.clickAPost($(upcoming.content).data('id'), function (response) { });
						}
					};

					$(".fancybox").fancybox(fancyboxConfiguration);
					//$(".fancybox").fancybox(CatapultAnnounce.global.fancyboxConfiguration);
				});
			}
			catch (ex) { console.log('Exception: ' + ex); }

			CatapultAnnounce.fireEvent("finished", { view: 'SlideShowView', operation: 'FillPosts', error: false });
		}, function (jqXHR, textStatus, errorThrown)
		{
			console.log("fillPosts(): " + textStatus + " : " + errorThrown);
			CatapultAnnounce.fireEvent("finished", { view: 'SlideShowView', operation: 'FillPosts', error: false });
		});
	}

	function catapultannounceItemLink_onclick(e)
	{
		e.preventDefault();
	}

	function fancyboxAllItemsButton_onclick(e)
	{
		e.preventDefault();

		CatapultAnnounce.global.WorkingPostId('');
		document.location.href = CatapultAnnounce.global.BlogViewUrl;
	}

	function fillAlerts()
	{
		var url = CatapultAnnounce.global.ProgramUrl + "Connector/Alert/List/" + CatapultAnnounce.global.FeedList.join(',');
		CatapultAnnounce.ServiceConnector.connect('GET', {}, url, function (response)
		{
			var alertTriggerContainer = $('#catapultannounce-alertTrigger').empty();
			var fancyboxContainer = $('#catapultannounce-alertFacyboxContainer').empty();

			if (response && response.length > 0)
			{
				var screenWidth = getScreenWidth();
				for (count = 0; count < response.length; count++)
				{
					var item = response[count];

					// output hidden alert trigger
					var linkItem = $('<a/>', { html: '<span class="ada">Alert Trigger</span>', class: 'catapultannounce-link alert-fancybox', 'rel': 'catapultannounce-slideshow', href: '#inline' + item.Id, 'data-id': item.Id, 'target': '_blank' }).appendTo(alertTriggerContainer);

					// fancybox item
					var fancyboxItem = $('<div/>', { 'id': 'inline' + item.Id, class: 'catapultannounce-popup', 'data-alerttype': item.AlertType, style: 'display:none;' }).appendTo(fancyboxContainer);

					//var fancyboxTitleRow = $('<div/>', { class: 'catapultannounce-title-row' }).appendTo(fancyboxItem);
					//$('<h2/>', { class: 'catapultannounce-title', html: item.Title }).appendTo(fancyboxTitleRow);
					//$('<date/>', { class: 'catapultannounce-date', html: item.HRDetailPostDate }).appendTo(fancyboxTitleRow);

					var fancyboxArticle = $('<article/>', {}).appendTo(fancyboxItem);

					if (item.AlertType == 'info') { $('<img/>', { 'src': CatapultAnnounce.global.ProgramUrl + "catapultv2/images/info-alert.png", 'alt': 'Information Circle Icon', 'title': 'Information Circle Icon' }).appendTo(fancyboxArticle); }
					else if (item.AlertType == 'success') { $('<img/>', { 'src': CatapultAnnounce.global.ProgramUrl + "catapultv2/images/success-alert.png", 'alt': 'Checkbox Circle Icon', 'title': 'Checkbox Circle Icon' }).appendTo(fancyboxArticle); }
					else if (item.AlertType == 'warning') { $('<img/>', { 'src': CatapultAnnounce.global.ProgramUrl + "catapultv2/images/warning-alert.png", 'alt': 'Exclamation Triangle Icon', 'title': 'Exclamation Triangle Icon' }).appendTo(fancyboxArticle); }
					else if (item.AlertType == 'danger') { $('<img/>', { 'src': CatapultAnnounce.global.ProgramUrl + "catapultv2/images/danger-alert.png", 'alt': 'Exclamation Circle Icon', 'title': 'Exclamation Circle Icon' }).appendTo(fancyboxArticle); }
					else
					{
						if (screenWidth > 700)
						{
							if (item.PictureInfo && item.PictureInfo.Picture800Url != "")
							{
								$('<img/>', { src: item.PictureInfo.Picture800Url, 'alt': item.PictureAltTag, 'title': item.PictureAltTag }).appendTo(fancyboxArticle);
							}
							/* CA-126 - Don't override "bell" icon with District/School default picture
							else if (item.DefaultPictureInfo && item.DefaultPictureInfo.Picture800Url != "")
							{
								$('<img/>', { src: item.DefaultPictureInfo.Picture800Url, 'alt': item.DefaultPictureAltTag, 'title': item.DefaultPictureAltTag }).appendTo(fancyboxArticle);
							}*/
							else
							{
								$('<img/>', { 'src': CatapultAnnounce.global.ProgramUrl + "catapultv2/images/default-alert.png", 'alt': 'Alert Bell Icon', 'title': 'Alert Bell Icon' }).appendTo(fancyboxArticle);
							}
						}
						else
						{
							if (item.PictureInfo && item.PictureInfo.Picture500Url != "")
							{
								$('<img/>', { src: item.PictureInfo.Picture500Url, 'alt': item.PictureAltTag, 'title': item.PictureAltTag }).appendTo(fancyboxArticle);
							}
							/* CA-126 - Don't override "bell" icon with District/School default picture
							else if (item.DefaultPictureInfo && item.DefaultPictureInfo.Picture500Url != "")
							{
								$('<img/>', { src: item.DefaultPictureInfo.Picture500Url, 'alt': item.DefaultPictureAltTag, 'title': item.DefaultPictureAltTag }).appendTo(fancyboxArticle);
							}*/
							else
							{
								$('<img/>', { 'src': CatapultAnnounce.global.ProgramUrl + "catapultv2/images/default-alert.png", 'alt': 'Alert Bell Icon', 'title': 'Alert Bell Icon' }).appendTo(fancyboxArticle);
							}
						}
					}

					$('<h2/>', { class: 'catapultannounce-title', html: item.Title }).appendTo(fancyboxArticle);

					var descriptionHtml = "<div>" + item.Description + "</div>";

					if (item.Documents && item.Documents.length > 0)
					{
						// CA-127 Remove word "Documents"
						//descriptionHtml += "<div><br /></div><div><div><strong>Documents:</strong></div><ul>";
						descriptionHtml += "<div><br /></div><div><ul>";

						$.each(item.Documents, function (index, documentItem)
						{
							descriptionHtml += "<li><a href='" + documentItem.HRUrl + "' title='" + documentItem.Title + "' alt='" + documentItem.Title + "' target='_blank'>" + documentItem.Title + "</a></li>";
						});

						descriptionHtml += "</ul></div>";
					}

					descriptionHtml += "<div><br /></div>";

					$('<p/>', { html: descriptionHtml }).appendTo(fancyboxArticle);

					var fancyboxFooter = $('<footer/>', {}).appendTo(fancyboxItem);
					var dismissButton = $('<button/>', { 'class': 'dismiss-button', 'html': 'Dismiss', 'data-id': item.Id, 'data-close': false }).appendTo(fancyboxFooter);

					/* (2/14/2020) For now remove share */
					/*if (CatapultAnnounce.global.ShareUrl != "")
					{
						var fancyboxFooter = $('<footer/>', {}).appendTo(fancyboxItem);

						var shareButton = $('<a/>', { class: 'catapultannounce-right', href: '#', html: '<i class="fa fa-share" alt="Share" title="Share"></i> ' + item.DefaultShareButtonLabel + '', 'data-id': item.Id, 'data-shareurl': CatapultAnnounce.global.ShareUrl }).appendTo(fancyboxFooter);
						$(shareButton).on('click', shareButton_click);
					}
					else if (item.FeedShareUrl != "")
					{
						var fancyboxFooter = $('<footer/>', {}).appendTo(fancyboxItem);

						var shareButton = $('<a/>', { class: 'catapultannounce-right', href: '#', html: '<i class="fa fa-share" alt="Share" title="Share"></i> ' + item.DefaultShareButtonLabel + '', 'data-id': item.Id, 'data-shareurl': item.FeedShareUrl }).appendTo(fancyboxFooter);
						$(shareButton).on('click', shareButton_click);
					}*/
				}
			}

			try
			{
				$(document).ready(function ()
				{
					$('.dismiss-button').on('click', function (e)
					{
						e.preventDefault();

						var close = $(this).data('close');

						if (close)
						{
							try { $.fancybox.close(); }
							catch (ex) { console.log(ex); }
						}
						else
						{
							try { $.fancybox.next(); }
							catch (ex) { console.log(ex); }
						}
					});

					var fancyboxConfiguration = CatapultAnnounce.global.fancyboxAlertConfiguration;
					fancyboxConfiguration.modal = true;
					fancyboxConfiguration.loop = false;
					fancyboxConfiguration.afterLoad = function ()
					{
						var alertType = $(this.content).data('alerttype');
						$(this.wrap).addClass('alert ' + alertType);
					};

					fancyboxConfiguration.onUpdate = function()
					{
						if (this.index == (this.group.length - 1))
						{
							$(this.content).find('.dismiss-button').data('close', true);
						}
					}

					$(".alert-fancybox").fancybox(fancyboxConfiguration);
					$('.alert-fancybox').first().click();
				});
			}
			catch (ex) { console.log('Exception: ' + ex); }

		}, function (jqXHR, textStatus, errorThrown)
		{
			console.log("fillAlerts(): " + textStatus + " : " + errorThrown);
		});
	}
}(jQuery));
